blueprint:
  name: Light Control Sensor
  description: Turn on a light for 5 minutes when a binary sensor is triggered, but only if the sun is below the horizon.
  domain: automation
  input:
    light_entity:
      name: Light
      description: The light to control.
      selector:
        entity:
          domain: light
    activation_entity:
      name: Binary Sensor
      description: The binary sensor that triggers the light.
      selector:
        entity:
          domain: binary_sensor

    brightness_entity:
      name: Light Sensor
      description: The sensor measuring the areas brightness. 
      selector:
        entity:
          domain: sensor

    minutes_on:
      name: Duration in Minutes
      description: Number of minutes the light should stay on.
      default: 5
      selector:
        number:
          min: 1
          max: 1440
          unit_of_measurement: minutes

    brightness_threshold:
      name: Brightness Threshold
      description: When the brightness level is below this value the light should turn on. 
      default: 60
      selector:
        number:
          min: 0
          max: 100
       #   unit_of_measurement: '%'
trigger:
  - platform: state
    entity_id: !input activation_entity
    from: 'off'
    to: 'on'

condition:
  - condition: template
    template: "{{ !input brightness_entity|float < !input brightness_threshold|float}}"

action:
  - service: light.turn_on
    target:
      entity_id: !input light_entity
  - wait_for_trigger:
      - platform: state
        entity_id: !input activation_entity
        to: 'off'
  - delay:
      minutes: !input minutes_on
  - service: light.turn_off
    target:
      entity_id: !input light_entity

mode: restart
